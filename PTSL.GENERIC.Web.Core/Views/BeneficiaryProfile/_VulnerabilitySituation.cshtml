@model PTSL.GENERIC.Web.Core.Model.EntityViewModels.Beneficiary.SurveyVM

<div id="VulnerabilitySituation" class="collapse">
    <!-- VulnerabilitySituation -->
    <div id="VulnerabilitySituationList"></div>
    <div class="text-center">
        <button id="AddMoreVulnerabilitySituation" type="button" class="btn btn-outline-dark btn-sm">Add More Vulnerability <i class="fa fa-plus"></i></button>
    </div>
</div>

<script>
    function addVulnerabilityChildValidation() {
        $("#VulnerabilitySituation .MonetaryLoss").each(function (i, e) {
            var fieldName = "MonetaryLoss_" + i;
            $(e).attr("name", fieldName);
            $(e).rules("add", {
                min: 0,
            });
        });
    }
</script>

<script>
    var VulnerabilitySituationList = $("#VulnerabilitySituationList");
    var partialVulnerabilitySituationBase = null;
    $("#VulnerabilitySituation").validate();

    //$("[href='#VulnerabilitySituation']").one("click", function () {
        $(".loader").fadeIn("fast");
        $.ajax({
            cache: false,
            type: "GET",
            url: "/BeneficiaryProfile/LoadVulnerabilitySituationBase",
            success: function (data) {
                $(".loader").fadeOut("fast");

                partialVulnerabilitySituationBase = data;

                if (!@Model.Id) {
                    AddVulnerabilitySituationInUI();
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                $(".loader").fadeOut("fast");
            }
        })

        if (@Model.Id) {
            $(".loader").fadeIn("fast");
            $.ajax({
            cache: false,
                type: "GET",
                data: { surveyId: @Model.Id },
                url: "/BeneficiaryProfile/LoadVulnerabilitySituationBase",
                success: function (data) {
                    $(".loader").fadeOut("fast");

                    VulnerabilitySituationList.append(data);
                    addVulnerabilityChildValidation();
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    $(".loader").fadeOut("fast");
                }
            })
        }
    //});
</script>

<!-- Add new other income source -->
<script>
    function AddVulnerabilitySituationInUI() {
        if (!VulnerabilitySituationList.has('div')?.length) {
            VulnerabilitySituationList.append(partialVulnerabilitySituationBase);
            addVulnerabilityChildValidation();
            runVulnerabilitySituationIndex();
        }
    }

    $("#AddMoreVulnerabilitySituation").on("click", function () {
        VulnerabilitySituationList.append(partialVulnerabilitySituationBase);
        addVulnerabilityChildValidation();
        runVulnerabilitySituationIndex();
    })

    function runVulnerabilitySituationIndex() {
        $("#VulnerabilitySituationList div.card").each(function (index) {
            var id = index + 1;
            var dbId = $(this).find(".Id").val();
            $(this).attr("data-id", id)
            $(this).children(".card-body").children("h5").text(id);

            var removeItem = $(this).children(".card-body").children(".remove-item");
            removeItem.attr("onclick", `RemoveVulnerabilitySituation(${id}, ${dbId ?? 0})`);
        });
    }

    function RemoveVulnerabilitySituation(id, dbId = null) {
        if (dbId) {
            swal({
                title: "Are you sure?",
                text: "This item will be deleted on save!",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Yes, delete it!",
                closeOnConfirm: true
            }, function (isDeleted) {
                if (isDeleted) {
                    DeletedVulnerabilitySituations.push(dbId);
                    remove();
                }
            });

            return;
        } else {
            remove();
        }

        function remove() {
            var element = $("#VulnerabilitySituationList").find(`[data-id='${id}']`);
            element.hide('slow', function () {
                element.remove();
                runVulnerabilitySituationIndex();
            });
        }
    }
</script>
